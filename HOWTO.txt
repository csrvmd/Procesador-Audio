
---

## üì¶ ARCHIVO 12: HOWTO.txt

```text name=HOWTO.txt
================================================================================
PROCESADOR AUDIO CANAL SUR RADIO - DOCUMENTACI√ìN T√âCNICA DETALLADA
================================================================================

VERSI√ìN: 1.0.0
FECHA: 2026-02-09

================================================================================
1. DESCRIPCI√ìN GENERAL DEL PROYECTO
================================================================================

La aplicaci√≥n "Procesador Audio Canal Sur Radio" es una soluci√≥n web de 
procesamiento de audio que permite:

- Subir archivos de audio en m√∫ltiples formatos
- Aplicar tres tipos de filtros avanzados:
  * Reductor de Ruido (RNNoise)
  * Ecualizador Gr√°fico (High-Pass + 5 Bandas + Low-Pass)
  * Normalizador Din√°mico (Dynaudnorm)
- Generar previews en tiempo real (MP3)
- Descargar versiones procesadas (MP2)
- Visualizar waveforms de audio
- Generar m√∫ltiples versiones con diferentes par√°metros

Stack Tecnol√≥gico:
- Frontend: HTML5, CSS3, JavaScript (vanilla)
- Backend: PHP 7.4+
- Procesamiento: FFmpeg 4.2+
- Servidor: Apache 2.4+
- Base de datos: Ninguna (archivos en directorios)

================================================================================
2. ARQUITECTURA Y FLUJO DE APLICACI√ìN
================================================================================

2.1 SESIONES Y GESTI√ìN DE USUARIOS
------------------------------------

Identificaci√≥n:
- Cada usuario se identifica por su IP (REMOTE_ADDR)
- Las sesiones duran 15 minutos (SESSION_TIMEOUT = 900s)
- Los directorios temporales se nombran: IP_timestamp (ej: 10.204.2.5_1707468000)

Validaci√≥n de Sesi√≥n:
- Al cargar index.php se verifica si existe sesi√≥n anterior del mismo IP
- Si la sesi√≥n anterior no ha expirado (< 15 min), se reutiliza
- Si ha expirado, se elimina y se crea una nueva

Estado de Usuario:
- Guardado en variable global JavaScript `state`
- Incluye: filtros activados, par√°metros, archivo subido, etc.
- Se mantiene en memoria del navegador (SessionStorage opcional)

2.2 FLUJO DE PROCESAMIENTO
---------------------------

1. USUARIO ACCEDE A /noise/
   ‚îî‚îÄ index.php carga:
      ‚îú‚îÄ Constantes de configuraci√≥n
      ‚îú‚îÄ Validaci√≥n de FFmpeg y modelos RNNoise
      ‚îú‚îÄ Detecci√≥n de sesiones existentes
      ‚îî‚îÄ Renderizado HTML + CSS + JavaScript

2. USUARIO SUBE ARCHIVO
   ‚îî‚îÄ api/upload.php:
      ‚îú‚îÄ Recibe multipart/form-data (archivo + session_dir)
      ‚îú‚îÄ Valida formato de audio con ffprobe
      ‚îú‚îÄ Convierte a 48 kHz WAV (si necesario)
      ‚îú‚îÄ Genera MP3 preview original (128 kbps)
      ‚îú‚îÄ Genera PNG waveform con showwavespic
      ‚îî‚îÄ Retorna JSON con URLs y metadatos

3. USUARIO CONFIGURA FILTROS
   ‚îî‚îÄ JavaScript (en index.php):
      ‚îú‚îÄ Toggle de filtros (RNNoise, EQ, Dynaudnorm)
      ‚îú‚îÄ Selecci√≥n de modelo RNNoise
      ‚îú‚îÄ Ajuste de par√°metros (sliders)
      ‚îú‚îÄ Dibujo del gr√°fico de respuesta EQ (canvas)
      ‚îî‚îÄ Estado guardado en objeto `state`

4. USUARIO PULSA "APLICAR"
   ‚îî‚îÄ api/process.php:
      ‚îú‚îÄ Verifica l√≠mite de concurrencia (m√°x 10 procesos)
      ‚îú‚îÄ Crea lock file para controlar acceso
      ‚îú‚îÄ Construye comando FFmpeg din√°micamente
      ‚îú‚îÄ Ejecuta FFmpeg con timeout (600s)
      ‚îú‚îÄ Genera MP3 preview (128 kbps, 48 kHz)
      ‚îú‚îÄ Genera MP2 descargable (256 kbps, 48 kHz, est√©reo)
      ‚îú‚îÄ Genera PNG waveform
      ‚îú‚îÄ Limpia lock file
      ‚îî‚îÄ Retorna JSON con URLs de salida

5. USUARIO VE PREVIEWS
   ‚îî‚îÄ index.php (JavaScript):
      ‚îú‚îÄ Renderiza contenedor de previews
      ‚îú‚îÄ Carga MP3 en elemento <audio>
      ‚îú‚îÄ Renderiza waveform en <canvas>
      ‚îú‚îÄ Permite reproducci√≥n con controles HTML5
      ‚îî‚îÄ Proporciona bot√≥n de descarga para MP2

6. USUARIO DESCARGA ARCHIVO
   ‚îî‚îÄ api/download.php:
      ‚îú‚îÄ Valida par√°metros (filename, session_dir)
      ‚îú‚îÄ Verifica que ruta no escapa de TEMP_DIR
      ‚îú‚îÄ Configura headers HTTP para descarga
      ‚îî‚îÄ Env√≠a archivo MP2 al navegador

7. USUARIO PULSA "FINALIZAR"
   ‚îî‚îÄ api/finalize.php:
      ‚îú‚îÄ Elimina toda la carpeta de sesi√≥n
      ‚îú‚îÄ Borra todos los archivos temporales
      ‚îî‚îÄ Retorna JSON de confirmaci√≥n

================================================================================
3. DESCRIPCI√ìN DETALLADA DE CADA ARCHIVO
================================================================================

3.1 index.php
-------------

Prop√≥sito: 
- Interfaz principal de la aplicaci√≥n
- Gesti√≥n de sesiones
- Validaci√≥n de dependencias

Caracter√≠sticas principales:

a) CONFIGURACI√ìN INICIAL (l√≠neas 1-40)
   - Detecta IP del cliente: $_SERVER['REMOTE_ADDR']
   - Define constantes:
     * FFMPEG_PATH: ruta a ejecutable ffmpeg
     * TEMP_DIR: directorio temporal (/var/www/html/noise/temp)
     * RNNOISE_MODELS_DIR: ubicaci√≥n de modelos (.rnnn)
     * SESSION_TIMEOUT: 900s (15 minutos)
     * FFMPEG_TIMEOUT: 600s (10 minutos)
     * MAX_CONCURRENT_PROCESSES: 10
     * OUTPUT_SAMPLERATE: 48000 Hz
   
   - Crea directorio temp si no existe: mkdir(TEMP_DIR, 0750, true)
   - Genera directorio de sesi√≥n: TEMP_DIR/IP_timestamp
   - Detecta sesiones existentes: glob(TEMP_DIR/IP_*)
   - Limpia sesiones expiradas (> 15 min)

b) VALIDACIONES (l√≠neas 42-60)
   - Verifica FFmpeg en FFMPEG_PATH
   - Verifica existencia de modelos RNNoise:
     * bd.rnnn (Discursos)
     * cb.rnnn (General - default)
     * mp.rnnn (M√∫sica)
     * sh.rnnn (Ruidos extremos)
   - Muestra error fatal si falta alguno

c) HTML STRUCTURE (l√≠neas ~90-600)
   - <header>: T√≠tulo y descripci√≥n
   - <main>:
     * .upload-section: Subida de archivos (drag-drop + click)
     * #alertContainer: √Årea de alertas din√°micas
     * .filters-section: 3 grupos de filtros
       - RNNoise: tabla de modelos + slider mix
       - Ecualizador: HP, canvas, 5 faders verticales, LP
       - Dynaudnorm: slider intensidad
     * .action-buttons: APLICAR y FINALIZAR
     * .previews-container: lista de archivos generados

d) ESTILOS CSS (l√≠neas ~600-1100)
   - Dise√±o responsive con flexbox
   - Tema gradiente morado
   - Animaciones (spinner, transitions)
   - Sliders personalizados
   - Canvas para ecualizador y waveforms
   - Modales para confirmaciones

e) JAVASCRIPT (l√≠neas ~1100-1400)
   - CONFIG: objeto con IP y sessionDir
   - state: objeto con estado global
     * audioFile: File object del archivo subido
     * filters: configuraci√≥n de los 3 filtros
     * filtersApplied: contador de versiones generadas
   - setupEventListeners(): vincular todos los eventos
   - handleFileSelect(): procesamiento de archivo seleccionado
   - uploadFile(): enviar a api/upload.php (AJAX)
   - toggleFilter(): activar/desactivar filtro
   - applyFilters(): enviar a api/process.php (AJAX)
   - drawEQResponse(): dibujar gr√°fico en canvas
   - renderPreview(): mostrar archivo generado
   - downloadFile(): descargar MP2
   - confirmFinalize(): mostrar modal de confirmaci√≥n
   - showSpinner()/hideSpinner(): loader visual

Flujo de Usuario:
1. Usuario carga p√°gina ‚Üí setupEventListeners()
2. Usuario selecciona archivo ‚Üí handleFileSelect() ‚Üí uploadFile()
3. Usuario ajusta filtros ‚Üí toggleFilter(), drawEQResponse()
4. Usuario pulsa APLICAR ‚Üí applyFilters()
5. Usuario ve previews ‚Üí renderPreview()
6. Usuario descarga ‚Üí downloadFile()
7. Usuario pulsa FINALIZAR ‚Üí confirmFinalize() ‚Üí confirmFinalizeAction()

3.2 api/upload.php
-------------------

Prop√≥sito:
- Recibir archivo de audio subido
- Validar formato
- Convertir a 48 kHz WAV
- Generar preview MP3 y waveform PNG

Entrada (POST multipart/form-data):
- $_FILES['audio']: archivo de audio
- $_POST['session_dir']: directorio de sesi√≥n (ej: 10.204.2.5_1707468000)

Proceso:

1. VALIDACI√ìN (l√≠neas 20-35)
   - Verifica m√©todo POST
   - Verifica que $_FILES['audio'] existe y sin error
   - Valida que session_dir es seguro (regex alphanum√©ricas)
   - Verifica que directorio de sesi√≥n existe

2. GUARDADO TEMPORAL (l√≠neas 37-43)
   - Obtiene: uploadedFile = $_FILES['audio']['tmp_name']
   - Sanitiza nombre original: preg_replace(/[^a-zA-Z0-9\-_]/, '')
   - Guarda en: $sessionPath/original_uploaded

3. INSPECCI√ìN CON FFPROBE (l√≠neas 45-60)
   - Ejecuta ffprobe: ffprobe -print_format json -show_format -show_streams
   - Extrae:
     * channels: n√∫mero de canales (1=mono, 2=est√©reo)
     * sample_rate: frecuencia de muestreo original
     * duration: duraci√≥n total en segundos

4. RESAMPLING A 48 kHz (l√≠neas 62-83)
   - Ejecuta FFmpeg: ffmpeg -i input -acodec pcm_s16le -ar 48000 output.wav
   - Convierte a 48 kHz PCM 16-bit WAV
   - Mantiene n√∫mero de canales original
   - Salida: $sessionPath/original.wav

5. GENERACI√ìN DE PREVIEW MP3 (l√≠neas 85-96)
   - Ejecuta: ffmpeg -i original.wav -q:a 5 -b:a 128k original.mp3
   - Bitrate: 128 kbps (formato web-friendly)
   - Quality: -q:a 5 (variable, buena calidad)
   - Salida: $sessionPath/original.mp3

6. GENERACI√ìN DE WAVEFORM (l√≠neas 98-110)
   - Ejecuta showwavespic: ffmpeg -i original.mp3 -filter_complex showwavespic
   - Par√°metros:
     * s=-1x100: ancho din√°mico, alto fijo 100px
     * colors=0x87CEEB: azul claro (lightblue en hex)
     * scale=log: escala logar√≠tmica para mejor visualizaci√≥n
   - Salida: $sessionPath/original.png

Salida (JSON):
{
  "success": true,
  "preview_url": "/noise/temp/IP_timestamp/original.mp3",
  "waveform_url": "/noise/temp/IP_timestamp/original.png",
  "duration": "00:05:42",
  "channels": 2,
  "sample_rate": 48000,
  "filename": "nombre_archivo"
}

3.3 api/process.php
--------------------

Prop√≥sito:
- Aplicar filtros de audio (RNNoise, EQ, Dynaudnorm)
- Generar MP3 preview y MP2 descargable
- Controlar concurrencia de procesos

Entrada (POST JSON):
{
  "session_dir": "10.204.2.5_1707468000",
  "original_filename": "mi_audio",
  "suffix": 1,
  "filters": {
    "rnnoise": {
      "model": "cb.rnnn",
      "mix": 0.8
    },
    "eq": {
      "hp": {"freq": 200},
      "bands": [0, 1.5, 0, -2.0, 0],
      "lp": {"freq": 3000}
    },
    "dynaudnorm": {
      "intensity": 0.5
    },
    "channels": 2,
    "sample_rate": 48000
  }
}

Proceso:

1. VALIDACI√ìN DE CONCURRENCIA (l√≠neas 30-50)
   - Cuenta locks activos: glob('/tmp/noise_locks/*.lock')
   - Si >= 10, retorna error 503 con mensaje amigable
   - Si < 10, contin√∫a y crea nuevo lock file

2. CONSTRUCCI√ìN DEL COMANDO FFMPEG (l√≠neas 52-150)
   - Funci√≥n buildFFmpegCommand():
   
   a) DETECCI√ìN DE CANALES
      - Lee channels del archivo con getFileChannels()
      - Retorna 1 (mono) o 2 (est√©reo)
   
   b) CONVERSI√ìN INICIAL
      - Si RNNoise activado: fuerza a MONO (aformat=channel_layouts=mono)
      - Raz√≥n: RNNoise entrena optimamente en mono
      - Si no RNNoise: mantiene canales originales
   
   c) RNNOISE (opcional)
      - Si filters['rnnoise'] est√° activo:
        * Obtiene modelo: cb.rnnn, bd.rnnn, mp.rnnn, sh.rnnn
        * Ejecuta: arnndn=m=/path/to/model.rnnn:mix=0.8
        * mix: par√°metro 0.0-1.0 de nivel de mezcla
        * Procesa en MONO (por entrenamiento)
   
   d) ECUALIZADOR (opcional)
      - High-Pass (si hp.enabled):
        * highpass=f=200:poles=2
        * f: frecuencia de corte (20-1000 Hz)
        * poles=2: 24 dB/octava (rolloff)
      
      - Bandas gr√°ficas (5 bandas):
        * Frecuencias fijas: 125, 500, 1000, 3000, 6000 Hz
        * Para cada banda con ganancia != 0:
          - equalizer=f=freq:t=q:width=1.0:g=gain
          - t=q: tipo Q (factor de calidad)
          - width=1.0: Q factor fijo
          - g: ganancia en dB (-6 a +6)
      
      - Low-Pass (si lp.enabled):
        * lowpass=f=3000:poles=2
        * f: frecuencia de corte (1000-8000 Hz)
        * poles=2: 24 dB/octava (rolloff)
   
   e) DYNAUDNORM (opcional)
      - Si filters['dynaudnorm'] est√° activo:
        * Mapeo de intensidad (0.0-1.0) a par√°metros:
          - 0.0-0.3 (Conservador): targetrms=0.20, threshold=0.10, m=5.0
          - 0.3-0.7 (Normal): targetrms=0.15, threshold=0.05, m=10.0
          - 0.7-1.0 (Agresivo): targetrms=0.10, threshold=0.01, m=15.0
        * Par√°metros fijos:
          - f=200: frame length (ideal para voz)
          - g=15: Gaussian size
          - p=0.9: Peak magnitude
          - cf=0.0: Factor de compresi√≥n
        * Comando: dynaudnorm=f=200:g=15:p=0.9:m=X:cf=0.0:targetrms=Y:threshold=Z
   
   f) RECONVERSI√ìN A EST√âREO
      - Si proces√≥ en MONO (por RNNoise):
        * aformat=channel_layouts=stereo
        * Expande mono a est√©reo (copia a ambos canales)

3. CONSTRUCCI√ìN DEL COMANDO COMPLETO
   - Encadena filtros con comas: filter1,filter2,filter3,...
   - Estructura final:
     ffmpeg -i original.wav \
       -af "filter_chain" \
       -c:a libmp3lame -q:a 5 -b:a 128k output.mp3 \
       -c:a libtwolame -b:a 256k -ar 48000 output.mp2

4. EJECUCI√ìN CON TIMEOUT (l√≠neas 152-190)
   - Usa proc_open() para control de procesos
   - Monitoriza status con proc_get_status()
   - Si procesa > 600s (FFMPEG_TIMEOUT): termina con signal 9
   - Si completa: verifica que se crearon archivos

5. GENERACI√ìN DE WAVEFORM (l√≠neas 192-202)
   - Mismo comando que en upload.php
   - Procesa el MP3 generado: showwavespic

6. PERMISOS Y RETORNO (l√≠neas 204-215)
   - chmod 644 en archivos generados
   - Retorna JSON:
     {
       "success": true,
       "preview_url": "/noise/temp/IP_timestamp/original_1.mp3",
       "waveform_url": "/noise/temp/IP_timestamp/original_1.png",
       "download_file": "original_1.mp2"
     }

Ejemplo de Cadena de Filtros Completa:
aformat=channel_layouts=mono,arnndn=m=/usr/local/share/rnnoise-models/cb.rnnn:mix=0.8,
highpass=f=200:poles=2,
equalizer=f=500:t=q:width=1.0:g=1.5,equalizer=f=3000:t=q:width=1.0:g=-2.0,
lowpass=f=3000:poles=2,
dynaudnorm=f=200:g=15:p=0.9:m=10.0:cf=0.0:targetrms=0.15:threshold=0.05,
aformat=channel_layouts=stereo

3.4 api/get_status.php
-----------------------

Prop√≥sito:
- Obtener estado de procesos en ejecuci√≥n
- Informaci√≥n de disponibilidad de slots

Entrada (GET): ninguna

Proceso:
1. Cuenta locks activos: glob('/tmp/noise_locks/*.lock')
2. Limpia locks > 15 minutos (sesiones expiradas)
3. Retorna JSON:
   {
     "success": true,
     "active_processes": 3,
     "max_processes": 10,
     "can_process": true
   }

Uso:
- Verificaci√≥n previa antes de APLICAR
- Feedback al usuario: "3 de 10 procesos en marcha"
- Permite mecanismo de reintentos

3.5 api/download.php
---------------------

Prop√≥sito:
- Descargar archivo MP2 procesado
- Validaci√≥n de seguridad (no escapa de TEMP_DIR)

Entrada (GET):
- file: nombre del archivo a descargar (ej: original_1.mp2)
- session_dir: directorio de sesi√≥n

Proceso:
1. VALIDACI√ìN (l√≠neas 20-45)
   - Verifica que file y session_dir no son vac√≠os
   - Valida con regex que son seguros (alphanumerics, guiones, puntos, underscore)
   - Construye ruta completa: TEMP_DIR/session_dir/file
   - Valida que ruta no escapa: strpos(realpath($filePath), realpath($sessionPath)) === 0

2. HEADERS HTTP (l√≠neas 47-52)
   - Content-Type: audio/mp2
   - Content-Disposition: attachment; filename="..."
   - Content-Length: tama√±o del archivo
   - Cache-Control: no-cache, no-store, must-revalidate
   - Pragma: no-cache
   - Expires: 0

3. DESCARGA (l√≠nea 54)
   - readfile($filePath): env√≠a archivo al navegador
   - El navegador lo descarga autom√°ticamente

Ejemplo de flujo:
Usuario pulsa "DESCARGAR" en original_1.mp2
  ‚îî‚îÄ JavaScript ejecuta: window.location.href = 'api/download.php?file=original_1.mp2&session_dir=10.204.2.5_1707468000'
  ‚îî‚îÄ Navegador recibe archivo con headers de descarga
  ‚îî‚îÄ Archivo se descarga a carpeta de Descargas del usuario

3.6 api/finalize.php
---------------------

Prop√≥sito:
- Eliminar toda la sesi√≥n del usuario
- Limpiar archivos temporales
- Preparar para nuevo ciclo

Entrada (POST JSON):
{
  "session_dir": "10.204.2.5_1707468000"
}

Proceso:
1. VALIDACI√ìN (l√≠neas 20-40)
   - Verifica que session_dir es seguro (regex)
   - Construye ruta: TEMP_DIR/session_dir
   - Valida que no escapa de TEMP_DIR

2. ELIMINACI√ìN RECURSIVA (l√≠neas 42-65)
   - Funci√≥n deleteDirectory($path):
     * Escanea todos los archivos/carpetas
     * Elimina recursivamente
     * Borra carpeta final

3. RETORNO (l√≠nea 67)
   {
     "success": true,
     "message": "Sesi√≥n finalizada y archivos eliminados"
   }

Trigger:
Usuario pulsa FINALIZAR
  ‚îî